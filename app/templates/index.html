<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script>
        var page_url = window.location.protocol + "//" + window.location.host + window.location.pathname;
    </script>
    <link id='style' rel="stylesheet" href="static/style/main.css">
	<script>document.getElementById("style").href = page_url + "static/style/main.css"</script>

    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
  </head>
  <body>
    <h1>Keyword Emergence Visualizer <span id="version">(version: {{ version }})</span></h1>
    <div style="width: 100%; overflow: hidden; margin-left: 4%; display: flex">
      <div style="flex: 50%; float: left; margin-top: 20px; margin-bottom: 0px;">
        <p id="description">
          We calcluated many measures from the the frequencies of keywords in the Astrophysics Data System (ADS).
          The two dropdowns contain names of values calculated from the keyword time series.
          A list of these measures can be found <a href="https://tsfresh.readthedocs.io/en/latest/text/list_of_features.html">here</a>.
          Code for generating this information can be found <a href="{{ git_url }}">here</a>.<br><br>
          On the left, there are a few predefined views which may be useful.
        </p>
      </div>
      <div id='options' style="flex: 50%; margin-left: 50px; margin-top:0px; float: right;">
        <ul style="list-style-type:none">
          <li>x: <select id="selectButtonX" class="selector"></select></li>
          <li>y: <select id="selectButtonY" class="selector"></select></li>
          <li>xScale: <select id="selectButtonXScale" class="selector"></select></li>
          <li>minimum count: <input id="minCountInput" value="0" type="number"></input></li>
          <li>minimum rake score: <input id="minRakeInput" value="0" type="number"></input></li>
          <li><button type="button" id="enterButton">Transform</button></li>
          <li><br></li>
          <li><button type="button" id="toggleNorm">Toggle Time Series Normalize</button></li>
        </ul>
      </div>
    </div>
    <div style="width: 100%; overflow: hidden;">
      <div id="views" style="width: 100px; float: left; margin-top: 50px">
        <div class="btn-group">
          <button id="cagrNasaafil">CAGR vs NASA Affiliation</button>
          <button id="manifold">manifold</button>
          <button id="maxSkew">First max location vs skewness</button>
          <button id="changeComplex">mean change vs complexity</button>
        </div>
      </div>
      <div id="plots" style="margin-left: 100px; height: 100%"></div>
    </div>
    <br>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script id="emergenceScript" src="../static/js/emergence_charts.js"></script>
    <script>document.getElementById("emergenceScript").src = page_url + "/static/js/emergence_charts.js"</script>
    <script type="text/javascript">
      var margin = { top: 20, right: 70, bottom: 100, left: 20 };
      var width = 600 - margin.left - margin.right;
      var height = 450 - margin.top - margin.bottom;

      var swidth = width + margin.left + margin.right;
      var sheight = height + margin.top + margin.bottom;

      var color = d3.scaleOrdinal(d3.schemeCategory10);

      var svgScaler = 1;

      // Append SVG
      var scatterSvg = d3.select('#plots')
        .append("svg")
        .attr("width", swidth * svgScaler)
        .attr("height", sheight * svgScaler)
        .attr("transform", "translate(" + (margin.left * svgScaler) + "," + (margin.top  * svgScaler) + ")");

      var timeSvg = d3.select("#plots")
      .append("svg")
      .attr('id', 'timeSvg')
      .attr("width", swidth * svgScaler)
      .attr("height", sheight * svgScaler)
      .attr("transform", "translate(" + (margin.left * svgScaler) + "," + (margin.top * svgScaler) + ")");

      // Add time series chart
      var timeChart = timeSeriesChart()
      .height(height)
      .width(width)
      .color(color);

      // add slope comp chart
      var chart0 = scatterChart()
      .height(height)
      .width(width)
      .xName('nasa_afil')
      .yName('cagr')
      .timeSvg(timeSvg)
      .timeChart(timeChart)
      .color(color);

      // add manifold chart
      var chart1 = scatterChart()
      .height(height)
      .width(width)
      .xName('manifold_x')
      .yName('manifold_y')
      .timeSvg(timeSvg)
      .timeChart(timeChart)
      .color(color);

      var min_count = -999;
      var minRake=-999;

      d3.json(window.location.pathname + "get-scatter-data", {
            method:"POST",
            body: JSON.stringify({
              x: 'nasa_afil', y: 'cagr', min_count: min_count, minRake: minRake
            }),
            headers: {
              "Content-type": "application/json; charset=UTF-8"
            }
          })
        .then(function(data) {
          scatterSvg
            .datum(data)
            .call(chart0);
          });

      d3.json(window.location.pathname + 'get-all-options')
        .then(
          function(options) {
            d3.select("#selectButtonX")
            .selectAll('myOptions')
            .data(options)
            .enter()
            .append('option')
            .text(function (d) { return d; }) // text showed in the menu
            .attr("value", function (d) { return d; }); // corresponding value returned by the button

            d3.select("#selectButtonY")
            .selectAll('myOptions')
            .data(options)
            .enter()
            .append('option')
            .text(function (d) { return d; }) // text showed in the menu
            .attr("value", function (d) { return d; }); // corresponding value returned by the button

            d3.select("#selectButtonXScale")
            .selectAll('myOptions')
            .data(['linear', '^0.1'])
            .enter()
            .append('option')
            .text(function (d) { return d; }) // text showed in the menu
            .attr("value", function (d) { return d; }); // corresponding value returned by the button

            d3.select("#enterButton").on("click", function(d) {
              // recover the option that has been chosen
              var selectedX = d3.select("#selectButtonX").property("value");
              var selectedY = d3.select("#selectButtonY").property("value");
              var min_count = d3.select("#minCountInput").property("value");
              var minRake = d3.select("#minRakeInput").property("value");
              var selectedXScale = d3.select("#selectButtonXScale").property("value");
              if (selectedXScale === '^0.1') {
                var xScale = d3.scalePow().exponent(0.1)
              }
              else {
                var xScale = d3.scaleLinear()
              }
              return scatterRequestPlot(d, selectedX, selectedY, min_count, minRake, xScale);
              }
            )}
        );

      d3.json(window.location.pathname + 'get-all-time-data')
        .then(
          function(data) {
            timeSvg.call(timeChart.data(data));
          }
      );


      d3.select('#toggleNorm').on('click', function(d) {
        tc = chart0.timeChart();
        if (tc.yName() === 'count') {
          tc.yName('norm_count')
        } else {
          tc.yName('count')
        }
      });

      function scatterRequestPlot(d, selectedX, selectedY, min_count=0, minRake=0, xScale=d3.scaleLinear()) {
        scatterSvg.selectAll('*').remove();
        d3.json(window.location.pathname + "get-scatter-data", {
          method:"POST",
          body: JSON.stringify({
            x: selectedX, y: selectedY, min_count: min_count, minRake: minRake
          }),
          headers: {
            "Content-type": "application/json; charset=UTF-8"
          }
        })
        .then(function(data) {
          scatterSvg
          .datum(data)
          .call(chart0.xName(selectedX).yName(selectedY).xScale(xScale));
        });
      }

      // Saved views
      d3.select("#cagrNasaafil").on("click", function (d) {
                let x = 'nasa_afil';
                let y = 'cagr';
                return scatterRequestPlot(d, x, y);
              }
      );

      d3.select("#manifold").on("click", function (d) {
          let x = 'manifold_x';
          let y = 'manifold_y';
          return scatterRequestPlot(d, x, y);
        }
      );

      d3.select("#maxSkew").on("click", function (d) {
                let x = 'value__skewness';
                let y = 'value__first_location_of_maximum';
                return scatterRequestPlot(d, x, y);
              }
      );

      d3.select("#changeComplex").on("click", function (d) {
                let x = 'value__mean_change';
                let y = 'value__cid_ce__normalize_False';
                return scatterRequestPlot(d, x, y);
              }
      );


    </script>
  <footer id="footerInfo">
    <p style="font-size: 16px">For questions, contact <a href = "mailto: anthony.r.buonomo@nasa.gov">anthony.r.buonomo@nasa.gov</a> or <a href = "mailto: brian.a.thomas@nasa.gov">brian.a.thomas@nasa.gov</a>.</p>
  </footer>
  </body>
</html>
